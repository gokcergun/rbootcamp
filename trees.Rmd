---
title: "Trees"
author: "Gökce Ergün"
date: "2/3/2021"
output: html_document
---
Hello world

Libraries that are used
```{r, warning=FALSE}
#install.packages('dplyr')
library(dplyr)
#install.package('lubridate')
library(lubridate)
#install.package('tidyr')
library(tidyr)
library(ggplot2)
```



Reading the data
```{r}
df_trees_orig <- read.csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-28/sf_trees.csv')

```

We create a copy of data to preserve its original form in case we want to look at it for reference
```{r}
df_trees <- df_trees_orig
```


We look at the data structure, and see all the string variables are saved as char. We would rather have them as factors for potential modelling use.
```{r}
str(df_trees)
```

Changing columns with type character to type factor. you need double brackets because single bracket indexing returns a df object,
which always evaluates to FALSE. Double brackets returns you the column as a vector whose data type can be tested. Alternatively, we can use single brackets but explicitly calling all rows and columns i.e [,i]
```{r}

for (i in 1:12){ 
    if (is.character(df_trees[,i]) == TRUE) {
    df_trees[,i]<-as.factor(df_trees[,i])
  }
  }

```

check the changes worked
```{r}
str(df_trees)
```


Check the percentage of missing values in each column

```{r}
for (col in colnames(df_trees)){
  print(paste(col, "=", mean(is.na(df_trees[[col]])))) #mean takes percentage here because adds up all TRUES (since their value is 1)
                                                       #and divides by total number of values (TRUE + FALSE)
}
```
Column with most significant amount of missing data is the **date** column.

We see almost every species has missing values (517 out of 571 species) so there is at least no clear indication that the data is missing not at random.
```{r}
df_trees %>% filter(is.na(date))%>%
  select(species)%>%
  unique() %>% dim()
 
```

further analysis of missing date values: percentage of observations with missing date values, per species.
```{r}
df_trees_datena <- df_trees %>% filter(is.na(date)) %>% 
  select(c(species, date)) %>%
  count(species)
  

df_trees_species_count <- df_trees %>% count(species)

df_trees_merge <- dplyr::left_join(df_trees_species_count, df_trees_datena, by="species", suffix = c("total", "date.na"))
df_trees_merge$percent.missing <- df_trees_merge$ndate.na / df_trees_merge$ntotal
df_trees_merge %>%
  arrange(desc(ntotal), desc(percent.missing))

```
```{r}
ggplot(df_trees_merge, aes(percent.missing))+geom_histogram(aes(y=..density..)) #using ggplot2
```

check number of **date** values per species 
```{r}
df_trees %>% filter(!is.na(date)) %>% 
  select(c(species, date)) %>%
  count(species) %>%
  arrange(desc(n)) %>% 
  top_n(20)
```


date column has char data type. We change it to date. 
```{r}
# df_trees$date <- as.Date(df_trees$date,format="%Y-%m-%d") #using base r

df_trees$date <- lubridate::ymd(df_trees$date) #using lubridate
```

check if change worked
```{r}
class(df_trees$date)
```


save the planted year of the tree as a separate column

```{r}
# df_trees$year <- format(df_trees$date, "%Y")  #using base r

df_trees$year <- year(df_trees$date) # using lubridate
class(df_trees$year)
```

checking year of plantation of oldest trees
```{r}
df_trees %>%
  select(year)%>%
  arrange() %>%  #ascending by default. function belongs to dplyr package
  head(10)
  
```

Create a new column that shows age using the year column to calculate it. Use the more modern approach mutate(). Then use age column 
to get an overview of the distribution of tree ages via a histogram.
```{r}

df_trees <- df_trees %>% 
  mutate(age = year(Sys.Date())-year)


hist(df_trees$age, main = 'Tree Age Distribution', xlab = 'Age', col = 'royalblue2') # using base r

```




take a look at the format of species name in species column. 
```{r}
head(unique(df_trees$species))

```
we see that for each **species**, the species column reports both the latin and common names. For future analysis, it might be more 
convenient to split the latin and common names into respective columns. 

Separate the species column into latin and common name columns.
```{r}
df_trees <- df_trees %>% 
  separate(species, sep = "::", remove = FALSE, into = c('species_lat', 'species_nor'))
```



```{r}
length(unique(df_trees$species_lat))
length(unique(df_trees$species_nor))
```

Count the species

```{r}
df_trees %>%
  count(species_nor) %>%
  arrange(desc(n))
```



```{r}
df_trees %>%
  count(species_nor) %>%
  arrange(desc(n)) %>%
  top_n(n = 10)
```




Show number of distinct species in a street

```{r}
by_address <- df_trees %>%
  group_by(address) %>%
  summarize(n_distinct(species_lat))
```


```{r}
unique(df_trees[grep(df_trees$species, pattern = "Acacia", ignore.case = TRUE), 'species'])

```




- most planted species in each decade 
  - na.omit - the observations that has an age
  
- map shows the top 5(/10) most planted species on a map

- another map with rare (n=1/below 5) species 











